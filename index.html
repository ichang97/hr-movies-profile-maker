<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster Style Text App</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        h1 { margin-bottom: 20px; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 500px; margin-bottom: 20px; box-sizing: border-box;}
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select, input[type="file"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: vertical; height: 100px; }
        .canvas-container { 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            line-height: 0;
            max-width: 100%;
            overflow: auto;
        }
        canvas { 
            background-color: #ddd; 
            /* ให้ canvas แสดงผลไม่เกินหน้าจอ แต่ size จริงจะเท่ารูปต้นฉบับ */
            max-width: 100%; 
            height: auto; 
            display: block;
        }
    </style>
</head>
<body>

    <h1>สร้างข้อความสไตล์โปสเตอร์ (ตามสัดส่วนรูป)</h1>

    <div class="controls">
        <div class="form-group">
            <label>1. อัปโหลดรูปภาพ (บังคับ)</label>
            <input type="file" id="imageLoader" accept="image/*">
        </div>
        
        <div class="form-group">
            <label>2. พิมพ์ข้อความ (Enter เพื่อเว้นบรรทัด)</label>
            <textarea id="textInput" placeholder="พิมพ์ข้อความที่นี่...&#10;เว้นบรรทัดได้">เราต่างเป็น&#10;พนักงานใหม่&#10;ของโลกใบนี้</textarea>
        </div>

        <div class="form-group">
            <label>3. เลือกฟอนต์ (หรืออัปโหลด)</label>
            <input type="file" id="fontLoader" accept=".ttf,.otf,.woff,.woff2" style="margin-bottom: 5px;">
            <select id="fontSelect">
                <option value="'Kanit', sans-serif">Kanit (Google)</option>
                <option value="'Sarabun', sans-serif">Sarabun (Google)</option>
                <option value="Arial, sans-serif">Arial</option>
            </select>
        </div>
        
        <button onclick="downloadImage()" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px;">บันทึกรูปภาพ</button>
    </div>

    <div class="canvas-container">
        <canvas id="imageCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        
        const imageLoader = document.getElementById('imageLoader');
        const fontLoader = document.getElementById('fontLoader');
        const textInput = document.getElementById('textInput');
        const fontSelect = document.getElementById('fontSelect');

        let uploadedImage = null;
        let currentFont = fontSelect.value;

        // ข้อความเริ่มต้นตอนยังไม่มีรูป
        ctx.canvas.width = 600;
        ctx.canvas.height = 400;
        ctx.fillStyle = "#ccc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#666";
        ctx.font = "bold 30px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("กรุณาอัปโหลดรูปภาพก่อน", canvas.width/2, canvas.height/2);

        // Event Listeners
        imageLoader.addEventListener('change', handleImage);
        fontLoader.addEventListener('change', handleCustomFont);
        textInput.addEventListener('input', draw);
        fontSelect.addEventListener('change', (e) => {
            currentFont = e.target.value;
            draw();
        });

        function handleImage(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                uploadedImage = new Image();
                uploadedImage.onload = function() {
                    // ปรับขนาด Canvas ให้เท่ากับรูปภาพต้นฉบับจริงๆ
                    canvas.width = uploadedImage.naturalWidth;
                    canvas.height = uploadedImage.naturalHeight;
                    draw();
                }
                uploadedImage.src = event.target.result;
            }
            if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        }

        function handleCustomFont(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontData = e.target.result;
                const customFont = new FontFace('CustomFont', fontData);
                customFont.load().then((loadedFont) => {
                    document.fonts.add(loadedFont);
                    currentFont = 'CustomFont';
                    
                    // อัปเดต Select box
                    let option = fontSelect.querySelector("option[value='CustomFont']");
                    if(!option) {
                        option = document.createElement("option");
                        option.text = "--- ฟอนต์ที่อัปโหลด ---";
                        option.value = "CustomFont";
                        fontSelect.add(option);
                    }
                    option.selected = true;
                    draw();
                });
            }
            reader.readAsArrayBuffer(file);
        }

        function draw() {
            if (!uploadedImage) return;

            // 1. Clear & Draw Image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(uploadedImage, 0, 0);

            const text = textInput.value;
            // แยกบรรทัดด้วย \n
            const lines = text.split('\n');
            
            // คำนวณขนาดต่างๆ ตามความกว้างรูป เพื่อให้ scale สวยงาม
            const fontSize = canvas.width * 0.08; // ขนาดฟอนต์ 8% ของความกว้างรูป
            const lineHeight = fontSize * 1.2;    // ความสูงบรรทัด
            const dotSize = fontSize * 0.04;      // ความหนาของจุด
            const dotSpacing = fontSize * 0.06;   // ระยะห่างจุด

            ctx.font = `bold ${fontSize}px ${currentFont}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            // คำนวณจุดกึ่งกลาง
            const startX = canvas.width / 2;
            // คำนวณจุดเริ่มแกน Y ให้กลุ่มข้อความอยู่ตรงกลางพอดี
            const totalHeight = lines.length * lineHeight;
            let startY = (canvas.height - totalHeight) / 2 + (lineHeight/2);

            // --- ส่วนที่ 1: วาดเส้นบรรทัดสีน้ำเงิน (Notebook Lines) ---
            ctx.setLineDash([]); // เส้นทึบ
            ctx.strokeStyle = "rgba(137, 207, 240, 0.8)"; // สีฟ้าอ่อนๆ โปร่งแสง
            ctx.lineWidth = dotSize * 0.8; // เส้นบางๆ

            lines.forEach((line, index) => {
                const y = startY + (index * lineHeight);
                // วาดเส้นที่ระดับเดียวกับ textBaseline (กลางตัวหนังสือ)
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            });

            // --- ส่วนที่ 2: วาดตัวหนังสือจุดสีขาว (Dotted Text) ---
            // เทคนิคทำจุดกลม: setLineDash([0, spacing]) แล้วใช้ lineCap = "round"
            ctx.setLineDash([0, dotSpacing]); 
            ctx.lineCap = "round";
            ctx.strokeStyle = "white";
            ctx.lineWidth = dotSize;

            lines.forEach((line, index) => {
                const y = startY + (index * lineHeight);
                // ใช้ strokeText เพื่อวาดขอบเป็นจุด
                ctx.strokeText(line, startX, y);
                // (Optional) fill สีขาวจางๆ ทับ เพื่อให้จุดดูเด่นขึ้นในที่มืด
                ctx.fillStyle = "rgba(255,255,255,0.2)";
                ctx.fillText(line, startX, y);
            });
        }
        
        function downloadImage() {
            if(!uploadedImage) {
                alert("กรุณาอัปโหลดรูปภาพก่อนบันทึก");
                return;
            }
            const link = document.createElement('a');
            link.download = 'poster-style.png';
            link.href = canvas.toDataURL('image/png', 1.0); // คุณภาพสูงสุด
            link.click();
        }
    </script>
</body>
</html>